{% extends 'base/base.html' %}

{% block title %} Chat with {{ chatTitle }}{% endblock %}

{% block specific_includes %}
        <script src="{{ url_for('static', filename='javascript/audio.js') }}"></script>
        <script src="{{ url_for('static', filename='javascript/chat.js') }}"></script>
{%endblock%}

{% block custom_script %}
    let socket
    let recipients
    let conversationId
    let loggedUserName
    $(document).ready(() => {
        recipients = [];
        {% for user in recipientsList %}
            var recipientId = {{user.id}};
            recipients.push(recipientId);
        {% endfor %}
        initializeSocket();
        setUIEventHandlers();
        scrollDownChat();
    });
{% endblock %}

{% block body %}

{% import 'macros/macros.html' as macros %}
{{ macros.navbar(actual_user.name.decode()) }}

<h1>Chat with: {{ chatTitle.name }}</h1>
<div class="container-fluid">
  <div class="row">
    <div class="col-md-8">
        <div role="tabpanel" class="tab-pane active" id="chat">
            <ul messages class="list-group">
                {% for message in conversation.messages%}
                  <a user class='list-group-item {{ 'loggedUserMessage' if  (message.fromUser.name.decode() == actual_user.name.decode()) else ''}}'>
                    <h4 name class="list-group-item-heading">{{message.fromUser.name.decode()}}</h4>
                    {% if message.type == 'text' %}
                        <p text class="list-group-item-text">{{message.payload}}</p>
                    {% endif %}
                    {% if message.type == 'audio' %}
                        <audio controls>
                            <source src='/static/_files/audio/{{message.payload}}'>
                        </audio>
                    {% endif %}
                    {% if message.type == 'image' %}
                        <img src='/static/_files/image/{{message.payload}}' />
                    {% endif %}
                  </a>
                {% endfor %}
            </ul>
        </div>
    </div>
    <div class="col-md-4">
        <div class="row">
             <img id="record" src="{{ url_for('static', filename='img/mic128.png') }}" onclick="toggleRecording(this);">
             <img id="imageIcon" height="100" width="100" src="{{ url_for('static', filename='img/image_icon.jpg') }}" onclick="$('#file').click()">
        </div>
    </div>
  </div>
  <div class="row">
    <div class="col-md-12">
         <input id="text" size="80" placeholder="Enter your message here">
    </div>
  </div>
</div>
<a style="display:none" href="#" >Leave this room(TODO: redirect to chat list)</a>
<input style="display:none" type="file" id="file" name="file">
<input id="loggedUserName" type="hidden" value="{{actual_user.name.decode()}}">
<input id="conversationId" type="hidden" value="{{conversation.id}}">
{% endblock %}


