{% extends 'base/base.html' %}

{% block title %}Index{% endblock %}

{% block custom_script %}
    let socket;
            let conversation = []
            $(document).ready(() => {
                socket = io.connect('http://' + document.domain + ':' + location.port + '/chat');
                socket.on('connect', () => {
                    socket.emit('joined', {});
                });

                socket.on('message', data => {
                    var userId = data.from.id;
                    $("#" + userId + " [last_received]").text(data.msg);
                    var unread = $("#" + userId + " [unread_count]").attr("unread_count");
                    $("#" + userId + " [unread_count]").attr("unread_count", parseInt(unread) + 1);
                    $("#" + userId + " [unread_count]").text(parseInt(unread) + 1);

                    console.log(data)
                });

                socket.on('status', data => {
                    console.log(data.msg)
                    if (data.msg.status !== 'ENTERED') return;
                    if ($(`#${data.msg.id}`) !== undefined) return;
                    let newUser = `list-group-item list-group-item-action" id={{actual_user.id}} data-toggle="list" `
                                + `href='#_${data.msg.id} role="tab" aria-controls=${data.msg.name}>${data.msg.name}</a>`
                    $('.list-group-item-action').last().append(newUser)
                });

                $("[user]").click(function() {
                    //location.href = "chat/" + this.id;
                    conversation = [this.id];
                    $("#conversation").text(this.id)
                });

                $("#send").click(() => {
                    msg = $("#msg").val()
                    if (msg !== '')
                      socket.emit('textMessage', msg, conversation);
                });

                $("#logout").click(() => {
                    console.log('log out')
                    socket.emit('left', {}, () => {
                        socket.disconnect();
                        window.location.href = "{{ url_for('auth.signin') }}";
                    });
                });

                $('#myTabs a').click(function (e) {
                  e.preventDefault()
                  $(this).tab('show')
                })
            });
{% endblock %}


{% block body %}
    {% import 'macros/macros.html' as macros %}
    {{ macros.navbar(actual_user.name.decode()) }}

    <ul id="myTabs" class="nav nav-tabs">
      <li role="presentation" class="active"><a href="#usuarios">Usuarios</a></li>
      <li role="presentation"><a href="#grupos">Grupos</a></li>
    </ul>

    <div class="tab-content">
        <div role="tabpanel" class="tab-pane active" id="usuarios">
            <ul class="list-group">
              {% for user in users %}
                  <a user id={{user.id}} class="list-group-item">
                    <span unread_count="0" class="badge badge-primary badge-pill"></span>
                    <h4 name class="list-group-item-heading">{{user.name}}</h4>
                    <p last_received class="list-group-item-text"></p>
                  </a>
              {% endfor %}
            </ul>
            <div class="centered">
                <p style="display: inline-block;">Hablando con</p>
                <p style="display: inline-block;" id=conversation> Nadie</p>
            </div>
            <div style="display: inline-block;" class="centered">
                <input id=msg></input>
                <button id='send'>Send</button>
            </div>
        </div>
        <div role="tabpanel" class="tab-pane" id="grupos">...</div>
    </div>
{% endblock %}
